<div class="profile-container">
  <!-- Message de chargement -->
  <div *ngIf="loading && !employeur" class="text-center py-5">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-2 text-muted">Chargement du profil...</p>
  </div>

  <!-- Carte de profil -->
  <div *ngIf="employeur || !loading" class="profile-card">
    <div class="profile-banner"></div>
    <div class="profile-header">
      <div class="position-relative">
        <img 
          [src]="photoPreview || employeur?.photoProfil || 'assets/images/LUM3.jpg'" 
          [alt]="displayName" 
          class="profile-avatar-xl"
        />
        <button 
          class="btn btn-sm btn-primary position-absolute bottom-0 end-0 rounded-circle"
          style="width: 36px; height: 36px; padding: 0;"
          (click)="editSection('photo')"
          title="Changer la photo"
        >
          <i class="bi bi-pencil"></i>
        </button>
        <input 
          #photoInput
          type="file"
          accept="image/*"
          style="display: none;"
          (change)="onPhotoSelected($event)"
        />
        <!-- Modal pour éditer la photo -->
        <div *ngIf="editingSection === 'photo'" class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Modifier la photo de profil</h5>
                <button type="button" class="btn-close" (click)="cancelEdit()"></button>
              </div>
              <div class="modal-body text-center">
                <img 
                  [src]="photoPreview || employeur?.photoProfil || 'assets/images/LUM3.jpg'" 
                  alt="Photo de profil" 
                  class="rounded-circle mb-3"
                  style="width: 150px; height: 150px; object-fit: cover;"
                />
                <input 
                  type="file"
                  accept="image/*"
                  class="form-control mb-3"
                  (change)="onPhotoSelected($event)"
                />
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="cancelEdit()">Annuler</button>
                <button type="button" class="btn btn-primary" (click)="savePhoto()" [disabled]="!selectedPhoto || loading">
                  {{ loading ? 'Enregistrement...' : 'Enregistrer' }}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="profile-summary">
        <h2 class="profile-name">{{ displayName }}</h2>
        <p class="profile-title">
          <span *ngIf="employeur?.typeEmployeur === 'ENTREPRISE'">
            <i class="bi bi-building me-1"></i>{{ employeur?.nomEntreprise || 'Entreprise' }}
          </span>
          <span *ngIf="employeur?.typeEmployeur === 'PARTICULIER'">
            <i class="bi bi-person me-1"></i>Particulier
          </span>
          <span *ngIf="employeur?.secteur"> · {{employeur?.secteur}} </span>
        </p>
        <p class="profile-meta">
          <i class="bi bi-geo-alt me-1"></i>
          {{ employeur?.adresse || 'Adresse non renseignée' }}
          <span *ngIf="employeur?.latitude && employeur?.longitude" class="text-muted">
            · {{ employeur?.latitude?.toFixed(4) }}, {{ employeur?.longitude?.toFixed(4) }}
          </span>
        </p>
        <div class="profile-actions">
          <button 
            *ngIf="!editing"
            class="btn btn-primary"
            (click)="toggleEdit()"
          >
            <i class="bi bi-pencil me-1"></i>Modifier le profil
          </button>
          <button 
            *ngIf="editing"
            class="btn btn-success"
            (click)="saveProfile()"
            [disabled]="loading"
          >
            <i class="bi bi-check me-1"></i>{{ loading ? 'Enregistrement...' : 'Enregistrer' }}
          </button>
          <button 
            *ngIf="editing"
            class="btn btn-outline-secondary"
            (click)="toggleEdit()"
            [disabled]="loading"
          >
            <i class="bi bi-x me-1"></i>Annuler
          </button>
        </div>
      </div>
    </div>

    <!-- Formulaire d'édition -->
    <div *ngIf="editing" class="profile-body">
      <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        <strong>Complétez votre profil</strong> pour améliorer votre visibilité auprès des employés.
      </div>

      <!-- Informations personnelles -->
      <section class="profile-section">
        <h5 class="section-title">
          <i class="bi bi-person-lines-fill me-2"></i>Informations personnelles
        </h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Nom <span class="text-danger">*</span></label>
            <input 
              type="text" 
              [(ngModel)]="employeurForm.nom" 
              class="form-control" 
              required
            />
          </div>
          <div class="col-md-6">
            <label class="form-label">Prénom <span class="text-danger">*</span></label>
            <input 
              type="text" 
              [(ngModel)]="employeurForm.prenom" 
              class="form-control" 
              required
            />
          </div>
          <div class="col-md-6">
            <label class="form-label">Email <span class="text-danger">*</span></label>
            <input 
              type="email" 
              [(ngModel)]="employeurForm.email" 
              class="form-control" 
              required
            />
          </div>
          <div class="col-md-6">
            <label class="form-label">Téléphone <span class="text-danger">*</span></label>
            <input 
              type="text" 
              [(ngModel)]="employeurForm.telephone" 
              class="form-control" 
              required
            />
          </div>
          <div class="col-md-6">
            <label class="form-label">Nouveau mot de passe</label>
            <input 
              type="password" 
              [(ngModel)]="employeurForm.password" 
              class="form-control" 
              placeholder="Laissez vide pour ne pas changer"
            />
            <small class="text-muted">Laissez vide si vous ne souhaitez pas changer votre mot de passe</small>
          </div>
        </div>
      </section>

      <!-- Informations professionnelles -->
      <section class="profile-section">
        <h5 class="section-title">
          <i class="bi bi-briefcase me-2"></i>Informations professionnelles
        </h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Type d'employeur <span class="text-danger">*</span></label>
            <select [(ngModel)]="employeurForm.typeEmployeur" class="form-control" required>
              <option value="">-- Sélectionnez un type --</option>
              <option value="ENTREPRISE">Entreprise</option>
              <option value="PARTICULIER">Particulier</option>
            </select>
          </div>
          <div class="col-md-6" *ngIf="employeurForm.typeEmployeur === 'ENTREPRISE'">
            <label class="form-label">Nom de l'entreprise <span class="text-danger">*</span></label>
            <input 
              type="text" 
              [(ngModel)]="employeurForm.nomEntreprise" 
              class="form-control" 
              required
            />
          </div>
          <div class="col-md-6">
            <label class="form-label">Secteur d'activité</label>
            <input 
              type="text" 
              [(ngModel)]="employeurForm.secteur" 
              class="form-control" 
              placeholder="Ex: Informatique, Marketing, Santé..."
            />
          </div>
          <div class="col-12">
            <label class="form-label">Description</label>
            <textarea 
              [(ngModel)]="employeurForm.description" 
              class="form-control" 
              rows="4"
              placeholder="Description de votre activité ou entreprise..."
            ></textarea>
          </div>
        </div>
      </section>

      <!-- Localisation -->
      <section class="profile-section">
        <h5 class="section-title">
          <i class="bi bi-geo-alt me-2"></i>Localisation
        </h5>
        <div class="form-group autocomplete-container">
          <label class="form-label">Adresse complète</label>
          <geoapify-geocoder-autocomplete 
            [value]="addressDisplayValue"
            [lang]="'fr'"
            [countryCodes]="['tg']"
            [limit]="5"
            [placeholder]="'Commencez à taper votre adresse'"
            (placeSelect)="onPlaceSelected($event)">
          </geoapify-geocoder-autocomplete>
          <small class="text-muted">
            <i class="bi bi-info-circle me-1"></i>Sélectionnez une adresse dans la liste pour une localisation précise
          </small>
          <div *ngIf="employeurForm.latitude && employeurForm.longitude" class="mt-2 text-success small">
            <i class="bi bi-check-circle-fill me-1"></i>Localisation détectée : {{ employeurForm.latitude.toFixed(4) }}, {{ employeurForm.longitude.toFixed(4) }}
          </div>
        </div>
      </section>
    </div>

    <!-- Affichage du profil (mode lecture) -->
    <div *ngIf="!editing" class="profile-body">
      <section class="profile-section position-relative">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="section-title mb-0">
            <i class="bi bi-person-lines-fill me-2"></i>Informations personnelles
          </h5>
          <button class="btn btn-sm btn-outline-primary" (click)="editSection('infos')" title="Modifier">
            <i class="bi bi-pencil me-1"></i>Modifier
          </button>
        </div>
        <div class="row g-3">
          <div class="col-md-6">
            <strong>Nom :</strong>
            <p>{{ employeur?.nom || 'Non renseigné' }}</p>
          </div>
          <div class="col-md-6">
            <strong>Prénom :</strong>
            <p>{{ employeur?.prenom || 'Non renseigné' }}</p>
          </div>
          <div class="col-md-6">
            <strong>Email :</strong>
            <p>{{ employeur?.email || 'Non renseigné' }}</p>
          </div>
          <div class="col-md-6">
            <strong>Téléphone :</strong>
            <p>{{ employeur?.telephone || 'Non renseigné' }}</p>
          </div>
        </div>
      </section>

      <section class="profile-section position-relative">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="section-title mb-0">
            <i class="bi bi-briefcase me-2"></i>Informations professionnelles
          </h5>
          <button class="btn btn-sm btn-outline-primary" (click)="editSection('pro')" title="Modifier">
            <i class="bi bi-pencil me-1"></i>Modifier
          </button>
        </div>
        <div class="row g-3">
          <div class="col-md-6">
            <strong>Type d'employeur :</strong>
            <p>
              <span [class]="employeur?.typeEmployeur === 'ENTREPRISE' ? 'badge bg-primary' : 'badge bg-info'">
                {{ employeur?.typeEmployeur === 'ENTREPRISE' ? 'Entreprise' : 'Particulier' }}
              </span>
            </p>
          </div>
          <div class="col-md-6" *ngIf="employeur?.nomEntreprise">
            <strong>Nom de l'entreprise :</strong>
            <p>{{ employeur?.nomEntreprise }}</p>
          </div>
          <div class="col-md-6" *ngIf="employeur?.secteur">
            <strong>Secteur d'activité :</strong>
            <p>{{ employeur?.secteur }}</p>
          </div>
        </div>
      </section>

      <section class="profile-section position-relative" *ngIf="employeur?.adresse">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="section-title mb-0">
            <i class="bi bi-geo-alt me-2"></i>Localisation
          </h5>
          <button class="btn btn-sm btn-outline-primary" (click)="editSection('localisation')" title="Modifier">
            <i class="bi bi-pencil me-1"></i>Modifier
          </button>
        </div>
        <p class="section-text">
          <i class="bi bi-geo-alt-fill me-2"></i>{{ employeur?.adresse }}
        </p>
      </section>
    </div>
  </div>
</div>

<!-- Modals pour l'édition des sections -->
<!-- Modal Informations personnelles -->
<div *ngIf="editingSection === 'infos'" class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Modifier les informations personnelles</h5>
        <button type="button" class="btn-close" (click)="cancelEdit()"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Nom <span class="text-danger">*</span></label>
            <input type="text" [(ngModel)]="employeurForm.nom" class="form-control" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Prénom <span class="text-danger">*</span></label>
            <input type="text" [(ngModel)]="employeurForm.prenom" class="form-control" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Email <span class="text-danger">*</span></label>
            <input type="email" [(ngModel)]="employeurForm.email" class="form-control" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Téléphone <span class="text-danger">*</span></label>
            <input type="text" [(ngModel)]="employeurForm.telephone" class="form-control" required />
          </div>
          <div class="col-12">
            <label class="form-label">Nouveau mot de passe</label>
            <input type="password" [(ngModel)]="employeurForm.password" class="form-control" placeholder="Laissez vide pour ne pas changer" />
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cancelEdit()">Annuler</button>
        <button type="button" class="btn btn-primary" (click)="saveSection('infos')" [disabled]="loading">
          {{ loading ? 'Enregistrement...' : 'Enregistrer' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Informations professionnelles -->
<div *ngIf="editingSection === 'pro'" class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Modifier les informations professionnelles</h5>
        <button type="button" class="btn-close" (click)="cancelEdit()"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Type d'employeur <span class="text-danger">*</span></label>
            <select [(ngModel)]="employeurForm.typeEmployeur" class="form-control" required>
              <option value="">-- Sélectionnez un type --</option>
              <option value="ENTREPRISE">Entreprise</option>
              <option value="PARTICULIER">Particulier</option>
            </select>
          </div>
          <div class="col-md-6" *ngIf="employeurForm.typeEmployeur === 'ENTREPRISE'">
            <label class="form-label">Nom de l'entreprise <span class="text-danger">*</span></label>
            <input type="text" [(ngModel)]="employeurForm.nomEntreprise" class="form-control" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Secteur d'activité</label>
            <input type="text" [(ngModel)]="employeurForm.secteur" class="form-control" placeholder="Ex: Informatique, Marketing, Santé..." />
          </div>
          <div class="col-12">
            <label class="form-label">Description</label>
            <textarea [(ngModel)]="employeurForm.description" class="form-control" rows="4" placeholder="Description de votre activité ou entreprise..."></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cancelEdit()">Annuler</button>
        <button type="button" class="btn btn-primary" (click)="saveSection('pro')" [disabled]="loading">
          {{ loading ? 'Enregistrement...' : 'Enregistrer' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Localisation -->
<div *ngIf="editingSection === 'localisation'" class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Modifier la localisation</h5>
        <button type="button" class="btn-close" (click)="cancelEdit()"></button>
      </div>
      <div class="modal-body">
        <div class="form-group autocomplete-container">
          <label class="form-label">Adresse complète</label>
          <geoapify-geocoder-autocomplete 
            [value]="addressDisplayValue"
            [lang]="'fr'"
            [countryCodes]="['tg']"
            [limit]="5"
            [placeholder]="'Commencez à taper votre adresse'"
            (placeSelect)="onPlaceSelected($event)">
          </geoapify-geocoder-autocomplete>
          <small class="text-muted">
            <i class="bi bi-info-circle me-1"></i>Sélectionnez une adresse dans la liste pour une localisation précise
          </small>
          <div *ngIf="employeurForm.latitude && employeurForm.longitude" class="mt-2 text-success small">
            <i class="bi bi-check-circle-fill me-1"></i>Localisation détectée : {{ employeurForm.latitude.toFixed(4) }}, {{ employeurForm.longitude.toFixed(4) }}
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cancelEdit()">Annuler</button>
        <button type="button" class="btn btn-primary" (click)="saveSection('localisation')" [disabled]="loading">
          {{ loading ? 'Enregistrement...' : 'Enregistrer' }}
        </button>
      </div>
    </div>
  </div>
</div>